<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>C on My New Hugo Site</title><link>https://petrie.github.io/tags/c/</link><description>Recent content in C on My New Hugo Site</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Thu, 12 Apr 2018 18:22:53 +0000</lastBuildDate><atom:link href="https://petrie.github.io/tags/c/index.xml" rel="self" type="application/rss+xml"/><item><title>PHP内存管理ZMM（五）－大内存区large_free_bucket的存入</title><link>https://petrie.github.io/posts/2018-04-12-php-zend-memory-manager4-large-free-bucket/</link><pubDate>Thu, 12 Apr 2018 18:22:53 +0000</pubDate><guid>https://petrie.github.io/posts/2018-04-12-php-zend-memory-manager4-large-free-bucket/</guid><description>&lt;p>之前的章节中介绍过large_free_bucket的存入条件。这一篇将介绍large_free_bucket的主要结构包括其中的链表结构和树结构和存入取出流程。本章讲通过图示大内存区域内存分部情况。&lt;/p>
&lt;h3 id="什么时候会向large_free_bucket存入内存块">什么时候会向large_free_bucket存入内存块&lt;/h3>
&lt;p>这里在复习下存入large_free_bucket流程。在调用emalloc申请能存，且在当前heap中没有找到合适内存块，emalloc函数会调用malloc向内核申请内存。向内核申请每次只能申请 heap-&amp;gt;block_size倍数大小内存。所以内核申请到的 heap-&amp;gt;block_size倍数 大小的内存并不会全部返回到emalloc调用者，而是有剩余。&lt;/p>
&lt;p>举个例子，假设heap-&amp;gt;block_size=256k，如果emalloc调用者申请大小为250k时，emalloc内部会向内核申请256k大小的内存。所以会有6k的内存剩余，这6k的内存将会存入到&lt;strong>大内存区large_free_bucket&lt;/strong>。&lt;/p>
&lt;p>另外一个例子，假设heap-&amp;gt;block_size=256k，如果emalloc调用者申请大小为260k（大于256k）时，emalloc会申请256*2=512k大小的内存，此时会有512k－260k＝252k的内存剩余。此时剩下的252k内存会存入到&lt;strong>剩余内存区rest_bucket&lt;/strong>。&lt;/p>
&lt;h3 id="手动构建large_free_bucket结构">手动构建large_free_bucket结构&lt;/h3>
&lt;h4 id="large_free_bucket结构举例">large_free_bucket结构举例&lt;/h4>
&lt;p>现在假设有以下内存块在large_free_bucket，分别为：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">大小&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">二进制&lt;/span> alloc_size
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">600&lt;/span> &lt;span style="color:#ae81ff">0000&lt;/span> &lt;span style="color:#ae81ff">0010&lt;/span> &lt;span style="color:#ae81ff">0101&lt;/span> &lt;span style="color:#ae81ff">1000&lt;/span> &lt;span style="color:#ae81ff">262144&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">48&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">600&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">261496&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">704&lt;/span> &lt;span style="color:#ae81ff">0000&lt;/span> &lt;span style="color:#ae81ff">0010&lt;/span> &lt;span style="color:#ae81ff">1100&lt;/span> &lt;span style="color:#ae81ff">0000&lt;/span> &lt;span style="color:#ae81ff">262144&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">48&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">704&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">261392&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">800&lt;/span> &lt;span style="color:#ae81ff">0000&lt;/span> &lt;span style="color:#ae81ff">0011&lt;/span> &lt;span style="color:#ae81ff">0010&lt;/span> &lt;span style="color:#ae81ff">0000&lt;/span> &lt;span style="color:#ae81ff">262144&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">48&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">800&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">261296&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">904&lt;/span> &lt;span style="color:#ae81ff">0000&lt;/span> &lt;span style="color:#ae81ff">0011&lt;/span> &lt;span style="color:#ae81ff">1000&lt;/span> &lt;span style="color:#ae81ff">1000&lt;/span> &lt;span style="color:#ae81ff">262144&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">48&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">904&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">261192&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">1000&lt;/span> &lt;span style="color:#ae81ff">0000&lt;/span> &lt;span style="color:#ae81ff">0011&lt;/span> &lt;span style="color:#ae81ff">1110&lt;/span> &lt;span style="color:#ae81ff">1000&lt;/span> &lt;span style="color:#ae81ff">262144&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">48&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1000&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">261096&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">600&lt;/span> &lt;span style="color:#ae81ff">0000&lt;/span> &lt;span style="color:#ae81ff">0010&lt;/span> &lt;span style="color:#ae81ff">0101&lt;/span> &lt;span style="color:#ae81ff">1000&lt;/span> &lt;span style="color:#ae81ff">262144&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">48&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">600&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">261496&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">704&lt;/span> &lt;span style="color:#ae81ff">0000&lt;/span> &lt;span style="color:#ae81ff">0010&lt;/span> &lt;span style="color:#ae81ff">1100&lt;/span> &lt;span style="color:#ae81ff">0000&lt;/span> &lt;span style="color:#ae81ff">262144&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">48&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">704&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">261392&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上面第一列中是准备存入heap中的内存大小，第二列为其二进制。第三列为_zend_mm_alloc_int传入的内存大小。&lt;/p></description></item><item><title>PHP内存管理ZMM（四）－GDB调试php源码并手动调用ZMM相关函数</title><link>https://petrie.github.io/posts/2018-04-11-php-zend-gdb-call/</link><pubDate>Wed, 11 Apr 2018 18:22:53 +0000</pubDate><guid>https://petrie.github.io/posts/2018-04-11-php-zend-gdb-call/</guid><description>&lt;p>本章讲介绍gdb调试php，并手动调用ZMM中申请内存和查找大内存块的函数&lt;/p>
&lt;ul>
&lt;li>_zend_mm_alloc_int&lt;/li>
&lt;li>zend_mm_search_large_block&lt;/li>
&lt;/ul>
&lt;h4 id="为什么要手动调用函数">为什么要手动调用函数&lt;/h4>
&lt;p>在阅读PHP ZMM源码的时候，有许多复杂的逻辑仅仅通过阅读源码很难理解，比如大内存large_free_buckets结构的构造。同构手动调用函数，可以方便的执行要申请的内存大小，从而测试构造large_free_buckets结构&lt;/p>
&lt;h4 id="编译安装php">编译安装PHP&lt;/h4>
&lt;p>从github上下载php源码&lt;/p>
&lt;p>编译到目录:~/php5.6-disabledebug，注意不要开启debug选项&lt;/p>
&lt;h4 id="gdb调试php">GDB调试PHP&lt;/h4></description></item><item><title>PHP内存管理ZMM（三）－内存分配函数emalloc</title><link>https://petrie.github.io/posts/2018-04-09-php-zend-memory-manager-2/</link><pubDate>Wed, 11 Apr 2018 10:22:53 +0000</pubDate><guid>https://petrie.github.io/posts/2018-04-09-php-zend-memory-manager-2/</guid><description>&lt;h4 id="主流程">主流程&lt;/h4>
&lt;p>emalloc是ZMM中heap层实现的函数，其内部调用_zend_mm_alloc_int函数。在_zend_mm_alloc_int中会依次在heap层的缓存区、小内存区、大内存区、剩余内存区寻找合适的内存。如果在这四个区域中都为查找到合适的内存，则调用malloc向内核申请，在向内核申请内存时，申请的大小必须是segment_size(256k)的整数倍，最小为256k。以下用流程图展示&lt;/p></description></item><item><title>PHP内存管理ZMM（二）－常见宏的值</title><link>https://petrie.github.io/posts/2018-04-09-normal-zend-macro-value/</link><pubDate>Mon, 09 Apr 2018 14:22:25 +0000</pubDate><guid>https://petrie.github.io/posts/2018-04-09-normal-zend-macro-value/</guid><description>&lt;h4 id="相关宏的定义">相关宏的定义&lt;/h4>
&lt;p>64位系统非debug模式编译后的&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_ALIGNMENT 8
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_ALIGNMENT_LOG2 3
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_MIN_SIZE ((ZEND_MM_ALIGNED_MIN_HEADER_SIZE&amp;gt;(ZEND_MM_ALIGNED_HEADER_SIZE+END_MAGIC_SIZE))?(ZEND_MM_ALIGNED_MIN_HEADER_SIZE-(ZEND_MM_ALIGNED_HEADER_SIZE+END_MAGIC_SIZE)):0)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_MAX_SMALL_SIZE ((ZEND_MM_NUM_BUCKETS&amp;lt;&amp;lt;ZEND_MM_ALIGNMENT_LOG2)+ZEND_MM_ALIGNED_MIN_HEADER_SIZE)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_ALIGNED_HEADER_SIZE ZEND_MM_ALIGNED_SIZE(sizeof(zend_mm_block))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_ALIGNED_FREE_HEADER_SIZE ZEND_MM_ALIGNED_SIZE(sizeof(zend_mm_small_free_block))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_MIN_ALLOC_BLOCK_SIZE ZEND_MM_ALIGNED_SIZE(ZEND_MM_ALIGNED_HEADER_SIZE + END_MAGIC_SIZE)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_ALIGNED_MIN_HEADER_SIZE (ZEND_MM_MIN_ALLOC_BLOCK_SIZE&amp;gt;ZEND_MM_ALIGNED_FREE_HEADER_SIZE?ZEND_MM_MIN_ALLOC_BLOCK_SIZE:ZEND_MM_ALIGNED_FREE_HEADER_SIZE)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_ALIGNED_SEGMENT_SIZE ZEND_MM_ALIGNED_SIZE(sizeof(zend_mm_segment))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_TRUE_SIZE(size) ((size&amp;lt;ZEND_MM_MIN_SIZE)?(ZEND_MM_ALIGNED_MIN_HEADER_SIZE):(ZEND_MM_ALIGNED_SIZE(size+ZEND_MM_ALIGNED_HEADER_SIZE+END_MAGIC_SIZE)))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_SMALL_SIZE(true_size) (true_size &amp;lt; ZEND_MM_MAX_SMALL_SIZE)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZEND_MM_BUCKET_INDEX(true_size) ((true_size&amp;gt;&amp;gt;ZEND_MM_ALIGNMENT_LOG2)-(ZEND_MM_ALIGNED_MIN_HEADER_SIZE&amp;gt;&amp;gt;ZEND_MM_ALIGNMENT_LOG2))
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>下面依次解释各个宏的含义和作用&lt;/p>
&lt;ul>
&lt;li>ZEND_MM_ALIGNMENT&lt;/li>
&lt;/ul>
&lt;p>内存对齐的时候用到，值为8，无特别的逻辑含义&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ZEND_MM_ALIGNMENT_LOG2&lt;/p>
&lt;p>辅助内存对齐的时候用到，值为3，无特别的逻辑含义&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>PHP内存管理ZMM(一)－基本概念、数据结构和相关初始化函数</title><link>https://petrie.github.io/posts/2018-04-08-php-zend-memory-manager/</link><pubDate>Sun, 08 Apr 2018 06:06:12 +0000</pubDate><guid>https://petrie.github.io/posts/2018-04-08-php-zend-memory-manager/</guid><description>&lt;h4 id="基本概念">基本概念&lt;/h4>
&lt;p>&lt;img src="http://flykobe.com/wp-content/uploads/2015/03/php-zend-memory-manager.jpg" alt="ZZM架构图">&lt;/p>
&lt;p>如上图所示，中间部分的zend memory manage由接口层、heap层、存储层(storage)组成。内存管理的主要逻辑在heap层中，后续主要讲解相关的数据结构和函数流程。&lt;/p>
&lt;h4 id="基本数据结构">基本数据结构&lt;/h4>
&lt;p>基于PHP-5.6&lt;/p>
&lt;h5 id="zend_mm_block_info">zend_mm_block_info&lt;/h5>
&lt;p>_zend_mm_block_info是ZMM内存管理中最小的数据单元。各字段含义见代码注释&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">typedef&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> _zend_mm_block_info {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#if ZEND_MM_COOKIES
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> size_t _cookie;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#endif
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> size_t _size;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> size_t _prev;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>} zend_mm_block_info;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>