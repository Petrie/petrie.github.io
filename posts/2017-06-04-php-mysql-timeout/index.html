<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>PHP设置连接mysql超时时间 | Petrie's Site</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="本文将分别介绍PHP的mysql扩展, mysqli扩展, mysql_pdo扩展,mysqlnd扩展和libmysql 这些名词的含义。以及他们之间的关系。最后再介绍如何配置mysql的超时时间。
一、mysql,mysqli,mysql_pdo,mysqlnd扩展
当考虑连接到MySQL数据库服务器的时候，有三种主要的API可供选择：

PHP的MySQL扩展
PHP的mysqli扩展
PHP数据对象(PDO)

三者都有各自的优缺点。下面的讨论就是为了对每种API的关键方面给出一个简短的介绍。"><meta name=generator content="Hugo 0.99.1"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="PHP设置连接mysql超时时间"><meta property="og:description" content="本文将分别介绍PHP的mysql扩展, mysqli扩展, mysql_pdo扩展,mysqlnd扩展和libmysql 这些名词的含义。以及他们之间的关系。最后再介绍如何配置mysql的超时时间。
一、mysql,mysqli,mysql_pdo,mysqlnd扩展
当考虑连接到MySQL数据库服务器的时候，有三种主要的API可供选择：

PHP的MySQL扩展
PHP的mysqli扩展
PHP数据对象(PDO)

三者都有各自的优缺点。下面的讨论就是为了对每种API的关键方面给出一个简短的介绍。"><meta property="og:type" content="article"><meta property="og:url" content="https://petrie.github.io/posts/2017-06-04-php-mysql-timeout/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-06-04T20:55:12+00:00"><meta property="article:modified_time" content="2017-06-04T20:55:12+00:00"><meta itemprop=name content="PHP设置连接mysql超时时间"><meta itemprop=description content="本文将分别介绍PHP的mysql扩展, mysqli扩展, mysql_pdo扩展,mysqlnd扩展和libmysql 这些名词的含义。以及他们之间的关系。最后再介绍如何配置mysql的超时时间。
一、mysql,mysqli,mysql_pdo,mysqlnd扩展
当考虑连接到MySQL数据库服务器的时候，有三种主要的API可供选择：

PHP的MySQL扩展
PHP的mysqli扩展
PHP数据对象(PDO)

三者都有各自的优缺点。下面的讨论就是为了对每种API的关键方面给出一个简短的介绍。"><meta itemprop=datePublished content="2017-06-04T20:55:12+00:00"><meta itemprop=dateModified content="2017-06-04T20:55:12+00:00"><meta itemprop=wordCount content="119"><meta itemprop=keywords content="php,mysql,"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP设置连接mysql超时时间"><meta name=twitter:description content="本文将分别介绍PHP的mysql扩展, mysqli扩展, mysql_pdo扩展,mysqlnd扩展和libmysql 这些名词的含义。以及他们之间的关系。最后再介绍如何配置mysql的超时时间。
一、mysql,mysqli,mysql_pdo,mysqlnd扩展
当考虑连接到MySQL数据库服务器的时候，有三种主要的API可供选择：

PHP的MySQL扩展
PHP的mysqli扩展
PHP数据对象(PDO)

三者都有各自的优缺点。下面的讨论就是为了对每种API的关键方面给出一个简短的介绍。"><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-T6WSQ8M692"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-T6WSQ8M692",{anonymize_ip:!1})}</script></head></head><body class="ma0 baskerville bg-washed-yellow"><header class="cover bg-top" style=background-image:url(https://petrie.github.io/images/gohugo-default-sample-hero-image.jpg)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Petrie's Site</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="我 页">我</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="文章 页">文章</a></li></ul><div class=ananke-socials><a href=https://github.com/petrie target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><h1 class="f2 f1-l fw2 white-90 mb0 lh-title">PHP设置连接mysql超时时间</h1></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">文章</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">PHP设置连接mysql超时时间</h1><time class="f6 mv4 dib tracked" datetime=2017-06-04T20:55:12Z>2017 六月 4日</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>本文将分别介绍PHP的mysql扩展, mysqli扩展, mysql_pdo扩展,mysqlnd扩展和libmysql 这些名词的含义。以及他们之间的关系。最后再介绍如何配置mysql的超时时间。</p><h1 id=一mysqlmysqlimysql_pdomysqlnd扩展>一、mysql,mysqli,mysql_pdo,mysqlnd扩展</h1><p>当考虑连接到MySQL数据库服务器的时候，有三种主要的API可供选择：</p><ul><li>PHP的MySQL扩展</li><li>PHP的mysqli扩展</li><li>PHP数据对象(PDO)</li></ul><p>三者都有各自的优缺点。下面的讨论就是为了对每种API的关键方面给出一个简短的介绍。</p><h2 id=什么是php的mysql扩展废弃><em>什么是PHP的MySQL扩展?</em>(废弃)</h2><p>这是设计开发允许PHP应用与MySQL数据库交互的早期扩展。<em>mysql</em>扩展提供了一个面向过程 的接口，并且是针对MySQL4.1.3或更早版本设计的。因此，这个扩展虽然可以与MySQL4.1.3或更新的数据库服务端 进行交互，但并不支持后期MySQL服务端提供的一些特性。</p><h2 id=什么是php的mysql_pdo扩展><em>什么是PHP的mysql_pdo扩展</em></h2><p><em>PHP 数据对象</em> （PDO） 扩展为PHP访问数据库定义了一个轻量级的一致接口。实现 PDO 接口的每个数据库驱动可以公开具体数据库的特性作为标准扩展功能。 注意利用 PDO 扩展自身并不能实现任何数据库功能；必须使用一个 具体数据库的 PDO 驱动 来访问数据库服务。</p><p>PDO 提供了一个 <em>数据访问</em> 抽象层，这意味着，不管使用哪种数据库，都可以用相同的函数（方法）来查询和获取数据。 PDO <em>不</em>提供 <em>数据库</em> 抽象层；它不会重写 SQL，也不会模拟缺失的特性。如果需要的话，应该使用一个成熟的抽象层。</p><p>从 PHP 5.1 开始附带了 PDO，在 PHP 5.0 中是作为一个 PECL 扩展使用。 PDO 需要PHP 5 核心的新 OO 特性，因此不能在较早版本的 PHP 上运行。</p><h2 id=什么是php的mysqli扩展>什么是PHP的mysqli扩展</h2><p><em>mysqli</em>扩展，我们有时称之为MySQL<em>增强</em>扩展，可以用于使用 MySQL4.1.3或更新版本中新的高级特性。<em>mysqli</em>扩展在PHP 5及以后版本中包含。</p><p><em>mysqli</em>扩展有一系列的优势，相对于<em>mysql</em>扩展的提升主要有：</p><ul><li>面向对象接口</li><li>prepared语句支持（译注：关于prepare请参阅mysql相关文档）</li><li>多语句执行支持</li><li>事务支持</li><li>增强的调试能力</li><li>嵌入式服务支持</li></ul><h2 id=什么是php的mysqlnd扩展><em>什么是PHP的mysqlnd扩展</em></h2><p><em>为了与MySQL数据库服务端进行交互，<em>mysql</em>扩展，<em>mysqli</em>扩展， PDO MySQL驱动都使用了实现了必要的协议的底层库。以前，可用的库只有MySQL客户端库和</em>libmysql*。*</p><p>然而，<em>libmysql</em>包含的接口没有针对与PHP的应用交互进行优化，<em>libmysql</em> 是早期为C应用程序设计的。基于这个原因，MySQL Native驱动<em>mysqlnd</em>，作为<em>libmysql</em>的一个 针对PHP应用的修改版本被开发。</p><p><em>mysql</em>，<em>mysqli</em>以及PDO Mysql驱动都可以各自配置使用 <em>libmysql</em>或者<em>mysqlnd</em>。<em>mysqlnd</em>作为一个专门设计 用于PHP系统的库，它在内存和速度上都比<em>libmysql</em>有很大提升。非常希望你去尝试这些提升。</p><h1 id=二如何设置php连接mysql的超时时间>二、如何设置php连接mysql的超时时间</h1><p>php连接mysql的超时可以分为三种：</p><ol><li>连接超时</li><li>读超时</li><li>写超时</li></ol><p>因为php连接mysql当前有两种连接方式，libmysql和mysqlnd（推荐）。</p><h2 id=首先libmysql><em>首先libmysql</em></h2><p>在libmysql这个底层库中，提供了MYSQL_OPT_CONNECT_TIMEOUT、MYSQL_OPT_READ_TIMEOUT、MYSQL_OPT_WRITE_TIME设置项的，并且提供了相关的API。</p><p>源码位置</p><p><code>mysql-VERSION/sql-common/client.c 3020行</code></p><p>MYSQL_OPT_CONNECT_TIMEOUT可以直接设置。但MYSQL_OPT_READ_TIMEOUT、MYSQL_OPT_WRITE_TIME因为mysqli没有导入这两个常量。所以需要查看MySQL的源码，得到MYSQL_OPT_READ_TIMEOUT、MYSQL_OPT_WRITE_TIME的实际值，然后直接调用mysql_option。但是mysql_pdo是写死的，所以没有任何办法设置MYSQL_OPT_READ_TIMEOUT、MYSQL_OPT_WRITE_TIME。</p><p>源码位置：</p><p><code>mysql-VERSION/include/mysql.h 160行</code></p><p>但是MYSQL_OPT_READ_TIMEOUT在mysql5.6版本以及之前（我们线上用的5.6），这个参数有以下三个限制。</p><ol><li>只能在TCP／IP协议下工作</li><li>MySQL server版本必须大于5.1.2</li><li>只能在windows下生效。</li></ol><h2 id=其次是mysqlnd><em>其次是mysqlnd</em></h2><p>对于libmysql和mysqlnd来讲，他们都是mysql、mysqli、mysqlpdo的底层库，这三个扩展才是对外暴露api的，所以说，他们对于这三种超时的支持，从代码层面是一样的。</p><p>但是对于<strong>MYSQL_OPT_READ_TIMEOUT</strong>，mysqlnd在php.ini层面多处配置</p><p><code>mysqlnd.net_read_timeout</code></p><p>这个配置会在执行耗时较长的sql时生效，并且报错“2006-MySQL Server has gone away”。</p><p>这个参数和libmysql的MYSQL_OPT_READ_TIMEOUT是极为相似的。但是MYSQL_OPT_READ_TIMEOUT这个参数是有使用场景的，上一小结已经阐述。</p><p>MYSQL_OPT_CONNECT_TIMEOUT和MYSQL_OPT_WRITE_TIME和libmysql是相同的。</p><h1 id=总而言之><em>总而言之</em></h1><p>推荐方案</p><ul><li>使用mysqlnd</li><li>配置 mysqlnd.net_read_time</li></ul><h1 id=引用>引用</h1><ul><li><a href=http://fendou.org/post/2011/05/06/mysql-communication-protocols/>mysql支持的四种协议</a></li><li><a href=blog.csdn.net/heiyeshuwu/article/details/5869813>MYSQL_OPT_READ_TIMEOUT设置</a></li><li><a href=http://php.net/manual/zh/mysqlnd.config.php#ini.mysqlnd.net-read-timeout>mysqlnd.net-read-time官方解释</a></li><li><a href=https://dev.mysql.com/doc/refman/5.6/en/mysql-options.html>MYSQL_OPT_CONNECT/READ/WRITE_TIMEOUT官方解释</a></li></ul><ul class=pa0>标签：<li class="list di"><a href=/tags/php class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">php</a></li><li class="list di"><a href=/tags/mysql class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">mysql</a></li></ul><ul class=pa0>分类：</ul><div class="mt6 instapaper_ignoref"><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//petrie.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">相关內容</p><ul class="pa0 list"><li class=mb2><a href=/posts/2017-04-10-mac-php-version/>更新Mac的PHP默认版本</a></li><li class=mb2><a href=/posts/2016-06-28-nignx-php%E4%B8%ADhttp%E8%AF%B7%E6%B1%82%E8%BF%94%E5%9B%9E502/>Nignx+PHP中HTTP请求返回502</a></li><li class=mb2><a href=/posts/2015-03-05-ci-config/>CI 环境配置</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://petrie.github.io/>&copy; Petrie's Site 2022</a><div><div class=ananke-socials><a href=https://github.com/petrie target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>