<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>PHP内存管理ZMM（四）－GDB调试php源码并手动调用ZMM相关函数 | Petrie's Site</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="本章讲介绍gdb调试php，并手动调用ZMM中申请内存和查找大内存块的函数

_zend_mm_alloc_int
zend_mm_search_large_block

为什么要手动调用函数
在阅读PHP ZMM源码的时候，有许多复杂的逻辑仅仅通过阅读源码很难理解，比如大内存large_free_buckets结构的构造。同构手动调用函数，可以方便的执行要申请的内存大小，从而测试构造large_free_buckets结构
编译安装PHP
从github上下载php源码
编译到目录:~/php5.6-disabledebug，注意不要开启debug选项
GDB调试PHP"><meta name=generator content="Hugo 0.99.1"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="PHP内存管理ZMM（四）－GDB调试php源码并手动调用ZMM相关函数"><meta property="og:description" content="本章讲介绍gdb调试php，并手动调用ZMM中申请内存和查找大内存块的函数

_zend_mm_alloc_int
zend_mm_search_large_block

为什么要手动调用函数
在阅读PHP ZMM源码的时候，有许多复杂的逻辑仅仅通过阅读源码很难理解，比如大内存large_free_buckets结构的构造。同构手动调用函数，可以方便的执行要申请的内存大小，从而测试构造large_free_buckets结构
编译安装PHP
从github上下载php源码
编译到目录:~/php5.6-disabledebug，注意不要开启debug选项
GDB调试PHP"><meta property="og:type" content="article"><meta property="og:url" content="https://petrie.github.io/posts/2018-04-11-php-zend-gdb-call/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-04-11T18:22:53+00:00"><meta property="article:modified_time" content="2018-04-11T18:22:53+00:00"><meta itemprop=name content="PHP内存管理ZMM（四）－GDB调试php源码并手动调用ZMM相关函数"><meta itemprop=description content="本章讲介绍gdb调试php，并手动调用ZMM中申请内存和查找大内存块的函数

_zend_mm_alloc_int
zend_mm_search_large_block

为什么要手动调用函数
在阅读PHP ZMM源码的时候，有许多复杂的逻辑仅仅通过阅读源码很难理解，比如大内存large_free_buckets结构的构造。同构手动调用函数，可以方便的执行要申请的内存大小，从而测试构造large_free_buckets结构
编译安装PHP
从github上下载php源码
编译到目录:~/php5.6-disabledebug，注意不要开启debug选项
GDB调试PHP"><meta itemprop=datePublished content="2018-04-11T18:22:53+00:00"><meta itemprop=dateModified content="2018-04-11T18:22:53+00:00"><meta itemprop=wordCount content="206"><meta itemprop=keywords content="php,c,gdb,"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP内存管理ZMM（四）－GDB调试php源码并手动调用ZMM相关函数"><meta name=twitter:description content="本章讲介绍gdb调试php，并手动调用ZMM中申请内存和查找大内存块的函数

_zend_mm_alloc_int
zend_mm_search_large_block

为什么要手动调用函数
在阅读PHP ZMM源码的时候，有许多复杂的逻辑仅仅通过阅读源码很难理解，比如大内存large_free_buckets结构的构造。同构手动调用函数，可以方便的执行要申请的内存大小，从而测试构造large_free_buckets结构
编译安装PHP
从github上下载php源码
编译到目录:~/php5.6-disabledebug，注意不要开启debug选项
GDB调试PHP"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Petrie's Site</a><div class="flex-l items-center"><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">PHP内存管理ZMM（四）－GDB调试php源码并手动调用ZMM相关函数</h1><time class="f6 mv4 dib tracked" datetime=2018-04-11T18:22:53Z>April 11, 2018</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>本章讲介绍gdb调试php，并手动调用ZMM中申请内存和查找大内存块的函数</p><ul><li>_zend_mm_alloc_int</li><li>zend_mm_search_large_block</li></ul><h4 id=为什么要手动调用函数>为什么要手动调用函数</h4><p>在阅读PHP ZMM源码的时候，有许多复杂的逻辑仅仅通过阅读源码很难理解，比如大内存large_free_buckets结构的构造。同构手动调用函数，可以方便的执行要申请的内存大小，从而测试构造large_free_buckets结构</p><h4 id=编译安装php>编译安装PHP</h4><p>从github上下载php源码</p><p>编译到目录:~/php5.6-disabledebug，注意不要开启debug选项</p><h4 id=gdb调试php>GDB调试PHP</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> gdb --args ~/php5.6-disabledebug/bin/php test.php 
</span></span></code></pre></div><p>test.php可以是任意可执行php代码</p><p>执行后设置断点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> b _zend_mm_alloc_int
</span></span><span style=display:flex><span>Breakpoint <span style=color:#ae81ff>1</span> at 0x6b2490: file /home/vagrant/php-src/Zend/zend_alloc.c, line 1881.
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> b zend_mm_add_to_free_list
</span></span><span style=display:flex><span>Breakpoint <span style=color:#ae81ff>2</span> at 0x6b12d0: file /home/vagrant/php-src/Zend/zend_alloc.c, line 734.
</span></span></code></pre></div><p>运行run命令执行test.php脚本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> run
</span></span><span style=display:flex><span>Starting program: /home/vagrant/php5.6-disabledebug/bin/php test.php
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Thread debugging using libthread_db enabled<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 1, _zend_mm_alloc_int <span style=color:#f92672>(</span>heap<span style=color:#f92672>=</span>0xe88d90, size<span style=color:#f92672>=</span>8192<span style=color:#f92672>)</span> at /home/vagrant/php-src/Zend/zend_alloc.c:1881
</span></span><span style=display:flex><span>1881	<span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>Missing separate debuginfos, use: debuginfo-install glibc-2.12-1.209.el6_9.2.x86_64 libxml2-2.7.6-21.el6_8.1.x86_64 nss-softokn-freebl-3.14.3-23.3.el6_8.x86_64 zlib-1.2.3-29.el6.x86_64
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span></code></pre></div><h4 id=执行_zend_mm_alloc_int函数申请500b的内存>执行_zend_mm_alloc_int函数申请500b的内存</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> call _zend_mm_alloc_int <span style=color:#f92672>(</span>0xe88d80, 500<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 1, _zend_mm_alloc_int <span style=color:#f92672>(</span>heap<span style=color:#f92672>=</span>0xe88d80, size<span style=color:#f92672>=</span>500<span style=color:#f92672>)</span> at /home/vagrant/php-src/Zend/zend_alloc.c:1881
</span></span><span style=display:flex><span>1881	<span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>The program being debugged stopped <span style=color:#66d9ef>while</span> in a <span style=color:#66d9ef>function</span> called from GDB.
</span></span><span style=display:flex><span>Evaluation of the expression containing the <span style=color:#66d9ef>function</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>_zend_mm_alloc_int<span style=color:#f92672>)</span> will be abandoned.
</span></span><span style=display:flex><span>When the <span style=color:#66d9ef>function</span> is <span style=color:#66d9ef>done</span> executing, GDB will silently stop.
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>执行20行代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> n <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Program received signal SIGSEGV, Segmentation fault.
</span></span><span style=display:flex><span>_zend_mm_alloc_int <span style=color:#f92672>(</span>heap<span style=color:#f92672>=</span>0xe88d80, size<span style=color:#f92672>=</span>500<span style=color:#f92672>)</span> at /home/vagrant/php-src/Zend/zend_alloc.c:1945
</span></span><span style=display:flex><span>1945				<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>UNEXPECTED<span style=color:#f92672>(</span>ZEND_MM_FREE_BLOCK_SIZE<span style=color:#f92672>(</span>p<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> true_size<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>查看heap各个字段的值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> p size
</span></span><span style=display:flex><span>$1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> p true_size
</span></span><span style=display:flex><span>$2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>520</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> p heap-&gt;size
</span></span><span style=display:flex><span>$3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> p heap-&gt;real_size
</span></span><span style=display:flex><span>$4 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>执行finish结束_zend_mm_alloc_int函数的执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> finish
</span></span><span style=display:flex><span>Run till exit from <span style=color:#75715e>#0  _zend_mm_alloc_int (heap=0xe88d80, size=500) at /home/vagrant/php-src/Zend/zend_alloc.c:1945</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Program terminated with signal SIGSEGV, Segmentation fault.
</span></span><span style=display:flex><span>The program no longer exists.
</span></span></code></pre></div><p>再次查看heap各个字段的值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> p heap-&gt;size
</span></span><span style=display:flex><span>$9 <span style=color:#f92672>=</span> <span style=color:#ae81ff>520</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> p heap-&gt;real_size
</span></span><span style=display:flex><span>$10 <span style=color:#f92672>=</span> <span style=color:#ae81ff>262144</span>
</span></span></code></pre></div><h4 id=如何执行zend_mm_search_large_block>如何执行zend_mm_search_large_block</h4><p>gdb调试过程中不知道什么原因。_zend_mm_alloc_int可以手动调用，但是zend_mm_search_large_block却不行。这里只能绕路调用。因为每次在调用_zend_mm_alloc_int必然会调用zend_mm_search_large_block。所以想调用</p><p>zend_mm_search_large_block，调用zend_mm_alloc_int即可。这里就不做演示了。</p><ul class=pa0><li class="list di"><a href=/tags/php class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">php</a></li><li class="list di"><a href=/tags/c class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">c</a></li><li class="list di"><a href=/tags/gdb class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">gdb</a></li></ul><div class="mt6 instapaper_ignoref"><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//petrieliu.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/posts/2018-04-09-php-zend-memory-manager-2/>PHP内存管理ZMM（三）－内存分配函数emalloc</a></li><li class=mb2><a href=/posts/2018-04-09-normal-zend-macro-value/>PHP内存管理ZMM（二）－常见宏的值</a></li><li class=mb2><a href=/posts/2018-03-29-first-php-extension/>PHP扩展开发－自动生成扩展骨架</a></li><li class=mb2><a href=/posts/2018-03-21-laravel-ioc/>如何独立的使用Laravel的IOC功能</a></li><li class=mb2><a href=/posts/2017-06-04-php-mysql-timeout/>PHP设置连接mysql超时时间</a></li><li class=mb2><a href=/posts/2017-04-10-mac-php-version/>更新Mac的PHP默认版本</a></li><li class=mb2><a href=/posts/2016-06-28-nignx-php%E4%B8%ADhttp%E8%AF%B7%E6%B1%82%E8%BF%94%E5%9B%9E502/>Nignx+PHP中HTTP请求返回502</a></li><li class=mb2><a href=/posts/2015-03-05-ci-config/>CI 环境配置</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://petrie.github.io/>&copy; Petrie's Site 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>