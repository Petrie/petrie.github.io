<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>PHP内存管理ZMM（三）－内存分配函数emalloc | Petrie's Site</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="主流程
emalloc是ZMM中heap层实现的函数，其内部调用_zend_mm_alloc_int函数。在_zend_mm_alloc_int中会依次在heap层的缓存区、小内存区、大内存区、剩余内存区寻找合适的内存。如果在这四个区域中都为查找到合适的内存，则调用malloc向内核申请，在向内核申请内存时，申请的大小必须是segment_size(256k)的整数倍，最小为256k。以下用流程图展示"><meta name=generator content="Hugo 0.110.0"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="PHP内存管理ZMM（三）－内存分配函数emalloc"><meta property="og:description" content="主流程
emalloc是ZMM中heap层实现的函数，其内部调用_zend_mm_alloc_int函数。在_zend_mm_alloc_int中会依次在heap层的缓存区、小内存区、大内存区、剩余内存区寻找合适的内存。如果在这四个区域中都为查找到合适的内存，则调用malloc向内核申请，在向内核申请内存时，申请的大小必须是segment_size(256k)的整数倍，最小为256k。以下用流程图展示"><meta property="og:type" content="article"><meta property="og:url" content="https://petrie.github.io/2018/04/php%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86zmm%E4%B8%89%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%87%BD%E6%95%B0emalloc/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-04-11T10:22:53+00:00"><meta property="article:modified_time" content="2018-04-11T10:22:53+00:00"><meta itemprop=name content="PHP内存管理ZMM（三）－内存分配函数emalloc"><meta itemprop=description content="主流程
emalloc是ZMM中heap层实现的函数，其内部调用_zend_mm_alloc_int函数。在_zend_mm_alloc_int中会依次在heap层的缓存区、小内存区、大内存区、剩余内存区寻找合适的内存。如果在这四个区域中都为查找到合适的内存，则调用malloc向内核申请，在向内核申请内存时，申请的大小必须是segment_size(256k)的整数倍，最小为256k。以下用流程图展示"><meta itemprop=datePublished content="2018-04-11T10:22:53+00:00"><meta itemprop=dateModified content="2018-04-11T10:22:53+00:00"><meta itemprop=wordCount content="2688"><meta itemprop=keywords content="php,c,"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP内存管理ZMM（三）－内存分配函数emalloc"><meta name=twitter:description content="主流程
emalloc是ZMM中heap层实现的函数，其内部调用_zend_mm_alloc_int函数。在_zend_mm_alloc_int中会依次在heap层的缓存区、小内存区、大内存区、剩余内存区寻找合适的内存。如果在这四个区域中都为查找到合适的内存，则调用malloc向内核申请，在向内核申请内存时，申请的大小必须是segment_size(256k)的整数倍，最小为256k。以下用流程图展示"><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-SZDN75YQDS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SZDN75YQDS",{anonymize_ip:!1})}</script></head><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!0,securityLevel:"loose"})</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4912480012550644" crossorigin=anonymous></script>
<link href=https://petrie.github.io/css/main.css rel=stylesheet type=text/css><link href=https://petrie.github.io/css/style.css rel=stylesheet type=text/css></head><body class="ma0 avenir bg-near-white"><header class="cover bg-top" style=background-image:url(https://petrie.github.io/images/php.png)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Petrie's Site</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="文章 页">文章</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/categories/ title="分类 页">分类</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tags/ title="标签 页">标签</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="关于我 页">关于我</a></li></ul><div class=ananke-socials><a href=https://github.com/petrie target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><h1 class="f2 f1-l fw2 white-90 mb0 lh-title">PHP内存管理ZMM（三）－内存分配函数emalloc</h1></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">文章</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">PHP内存管理ZMM（三）－内存分配函数emalloc</h1><time class="f6 mv4 dib tracked" datetime=2018-04-11T10:22:53Z>2018年04月11日</time>
<span class="f6 mv4 dib tracked">&nbsp;&nbsp;&nbsp;&nbsp; 2688 字</span>
<span class="f6 mv4 dib tracked">- 6 分钟</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-100-l"><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul></nav><h4 id=主流程>主流程</h4><p>emalloc是ZMM中heap层实现的函数，其内部调用_zend_mm_alloc_int函数。在_zend_mm_alloc_int中会依次在heap层的缓存区、小内存区、大内存区、剩余内存区寻找合适的内存。如果在这四个区域中都为查找到合适的内存，则调用malloc向内核申请，在向内核申请内存时，申请的大小必须是segment_size(256k)的整数倍，最小为256k。以下用流程图展示</p><pre tabindex=0><code class=language-flow data-lang=flow>st=&gt;start:   Start   |past:&gt;http://www.google.com[blank]
e=&gt;end: End:&gt;http://www.google.com
op1=&gt;operation: My Operation|past
op2=&gt;operation: Stuff|current
sub1=&gt;subroutine: My Subroutine|invalid
cond=&gt;condition: Yes or No?|approved:&gt;http://www.google.com
c2=&gt;condition: Good idea|rejected
io=&gt;inputoutput: catch something...|request
cache=&gt;operation: 查找缓存 heap- &gt;cache 
找到返回，未找到则继续|past
free_buckets=&gt;operation: 查找小块内存heap- &gt;free_buckets 
找到返回，未找到则继续|past
large_free_buckets=&gt;operation: 查找大块内存heap- &gt;large_free_buckets 
找到返回，未找到则继续|past
rest_buckets=&gt;operation: 查找剩余内存 heap- &gt;rest_buckets 
找到返回，未找到则继续|past
core_malloc=&gt;operation: 在heap四个区域中均为找到合适大小的内存，
则向内核申请内存
add_rest=&gt;operation: 将内核申请的内存分割为两部分，一部分函数返回，即本次申请的内存。
剩下的调用zend_mm_add_to_free_list，根据大小添加到heap的四个区域中
st-&gt;cache-&gt;free_buckets-&gt;large_free_buckets-&gt;rest_buckets-&gt;core_malloc-&gt;add_rest-&gt;e
</code></pre><h4 id=代码注解>代码注解</h4><p>代码如下：<a href=https://github.com/php/php-src/blob/9c1d686748cdb46e2f80a9bc800df0015fb709b1/Zend/zend_alloc.c#L1880>引自</a></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>  1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>  2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>  3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>  4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5>  5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6>  6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7>  7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8>  8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9>  9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-10> 10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-11> 11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-12> 12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-13> 13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-14> 14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-15> 15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-16> 16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-17> 17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-18> 18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-19> 19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-20> 20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-21> 21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-22> 22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-23> 23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-24> 24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-25> 25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-26> 26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-27> 27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-28> 28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-29> 29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-30> 30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-31> 31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-32> 32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-33> 33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-34> 34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-35> 35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-36> 36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-37> 37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-38> 38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-39> 39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-40> 40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-41> 41</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-42> 42</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-43> 43</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-44> 44</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-45> 45</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-46> 46</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-47> 47</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-48> 48</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-49> 49</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-50> 50</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-51> 51</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-52> 52</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-53> 53</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-54> 54</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-55> 55</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-56> 56</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-57> 57</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-58> 58</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-59> 59</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-60> 60</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-61> 61</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-62> 62</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-63> 63</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-64> 64</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-65> 65</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-66> 66</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-67> 67</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-68> 68</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-69> 69</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-70> 70</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-71> 71</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-72> 72</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-73> 73</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-74> 74</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-75> 75</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-76> 76</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-77> 77</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-78> 78</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-79> 79</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-80> 80</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-81> 81</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-82> 82</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-83> 83</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-84> 84</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-85> 85</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-86><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-86> 86</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-87><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-87> 87</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-88><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-88> 88</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-89><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-89> 89</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-90><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-90> 90</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-91><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-91> 91</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-92><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-92> 92</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-93><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-93> 93</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-94><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-94> 94</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-95><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-95> 95</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-96><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-96> 96</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-97><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-97> 97</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-98><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-98> 98</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-99><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-99> 99</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-100><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-100>100</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-101><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-101>101</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-102><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-102>102</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-103><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-103>103</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-104><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-104>104</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-105><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-105>105</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-106><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-106>106</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-107><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-107>107</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-108><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-108>108</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-109><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-109>109</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-110><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-110>110</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-111><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-111>111</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-112><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-112>112</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-113><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-113>113</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-114><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-114>114</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-115><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-115>115</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-116><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-116>116</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-117><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-117>117</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-118><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-118>118</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-119><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-119>119</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-120><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-120>120</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-121><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-121>121</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-122><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-122>122</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-123><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-123>123</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-124><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-124>124</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-125><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-125>125</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-126><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-126>126</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-127><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-127>127</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-128><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-128>128</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-129><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-129>129</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-130><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-130>130</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-131><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-131>131</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-132><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-132>132</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-133><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-133>133</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-134><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-134>134</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-135><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-135>135</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-136><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-136>136</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-137><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-137>137</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-138><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-138>138</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-139><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-139>139</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-140><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-140>140</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-141><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-141>141</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-142><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-142>142</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-143><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-143>143</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-144><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-144>144</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-145><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-145>145</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-146><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-146>146</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-147><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-147>147</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-148><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-148>148</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-149><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-149>149</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-150><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-150>150</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-151><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-151>151</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-152><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-152>152</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-153><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-153>153</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-154><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-154>154</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-155><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-155>155</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-156><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-156>156</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-157><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-157>157</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-158><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-158>158</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-159><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-159>159</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-160><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-160>160</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-161><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-161>161</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-162><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-162>162</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-163><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-163>163</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-164><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-164>164</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-165><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-165>165</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-166><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-166>166</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-167><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-167>167</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-168><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-168>168</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-169><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-169>169</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-170><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-170>170</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-171><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-171>171</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-172><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-172>172</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-173><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-173>173</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-174><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-174>174</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-175><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-175>175</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-176><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-176>176</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-177><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-177>177</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-178><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-178>178</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-179><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-179>179</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-180><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-180>180</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-181><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-181>181</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>static</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#000;font-weight:700>*</span><span style=color:#900;font-weight:700>_zend_mm_alloc_int</span>(zend_mm_heap <span style=color:#000;font-weight:700>*</span>heap, <span style=color:#458;font-weight:700>size_t</span> size ZEND_FILE_LINE_DC ZEND_FILE_LINE_ORIG_DC)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>   zend_mm_free_block <span style=color:#000;font-weight:700>*</span>best_fit;
</span></span><span style=display:flex><span>  <span style=color:#998;font-style:italic>//计算true_size,对于计算逻辑和取值可以参考上一篇文章
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>   <span style=color:#458;font-weight:700>size_t</span> true_size <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>ZEND_MM_TRUE_SIZE</span>(size);
</span></span><span style=display:flex><span>   <span style=color:#458;font-weight:700>size_t</span> block_size;
</span></span><span style=display:flex><span>   <span style=color:#458;font-weight:700>size_t</span> remaining_size;
</span></span><span style=display:flex><span>   <span style=color:#458;font-weight:700>size_t</span> segment_size;
</span></span><span style=display:flex><span>   zend_mm_segment <span style=color:#000;font-weight:700>*</span>segment;
</span></span><span style=display:flex><span>   <span style=color:#458;font-weight:700>int</span> keep_rest <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span>;
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#ifdef ZEND_SIGNALS
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>   <span style=color:#900;font-weight:700>TSRMLS_FETCH</span>();
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#endif
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>
</span></span><span style=display:flex><span>   <span style=color:#900;font-weight:700>HANDLE_BLOCK_INTERRUPTIONS</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>if</span> (<span style=color:#900;font-weight:700>EXPECTED</span>((true_size))) {
</span></span><span style=display:flex><span>     <span style=color:#998;font-style:italic>//根据true_size 计算 index的值
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      <span style=color:#458;font-weight:700>size_t</span> index <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>ZEND_MM_BUCKET_INDEX</span>(true_size);
</span></span><span style=display:flex><span>      <span style=color:#458;font-weight:700>size_t</span> bitmap;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>if</span> (<span style=color:#900;font-weight:700>UNEXPECTED</span>(true_size <span style=color:#000;font-weight:700>&lt;</span> size)) {
</span></span><span style=display:flex><span>         <span style=color:#000;font-weight:700>goto</span> out_of_memory;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#if ZEND_MM_CACHE </span><span style=color:#998;font-style:italic>//在缓存块中中查找
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      <span style=color:#000;font-weight:700>if</span> (<span style=color:#900;font-weight:700>EXPECTED</span>(heap<span style=color:#000;font-weight:700>-&gt;</span>cache[index] <span style=color:#000;font-weight:700>!=</span> <span style=color:#0086b3>NULL</span>)) {
</span></span><span style=display:flex><span>         <span style=color:#998;font-style:italic>/* Get block from cache */</span>
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#if ZEND_MM_CACHE_STAT
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         heap<span style=color:#000;font-weight:700>-&gt;</span>cache_stat[index].count<span style=color:#000;font-weight:700>--</span>;
</span></span><span style=display:flex><span>         heap<span style=color:#000;font-weight:700>-&gt;</span>cache_stat[index].hit<span style=color:#000;font-weight:700>++</span>;
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#endif
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         best_fit <span style=color:#000;font-weight:700>=</span> heap<span style=color:#000;font-weight:700>-&gt;</span>cache[index];
</span></span><span style=display:flex><span>         heap<span style=color:#000;font-weight:700>-&gt;</span>cache[index] <span style=color:#000;font-weight:700>=</span> best_fit<span style=color:#000;font-weight:700>-&gt;</span>prev_free_block;
</span></span><span style=display:flex><span>         heap<span style=color:#000;font-weight:700>-&gt;</span>cached <span style=color:#000;font-weight:700>-=</span> true_size;
</span></span><span style=display:flex><span>         <span style=color:#900;font-weight:700>ZEND_MM_CHECK_MAGIC</span>(best_fit, MEM_BLOCK_CACHED);
</span></span><span style=display:flex><span>         <span style=color:#900;font-weight:700>ZEND_MM_SET_DEBUG_INFO</span>(best_fit, size, <span style=color:#099>1</span>, <span style=color:#099>0</span>);
</span></span><span style=display:flex><span>         <span style=color:#900;font-weight:700>HANDLE_UNBLOCK_INTERRUPTIONS</span>();
</span></span><span style=display:flex><span>         <span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>ZEND_MM_DATA_OF</span>(best_fit);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#if ZEND_MM_CACHE_STAT
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>      heap<span style=color:#000;font-weight:700>-&gt;</span>cache_stat[index].miss<span style=color:#000;font-weight:700>++</span>;
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#endif
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#endif
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>	 <span style=color:#998;font-style:italic>//在小内存块中查找
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      bitmap <span style=color:#000;font-weight:700>=</span> heap<span style=color:#000;font-weight:700>-&gt;</span>free_bitmap <span style=color:#000;font-weight:700>&gt;&gt;</span> index;
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>if</span> (bitmap) { <span style=color:#998;font-style:italic>//如果bitmap不等于0，说明存在大于或等于true_size的内存
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>         <span style=color:#998;font-style:italic>/* Found some &#34;small&#34; free block that can be used */</span>
</span></span><span style=display:flex><span>         index <span style=color:#000;font-weight:700>+=</span> <span style=color:#900;font-weight:700>zend_mm_low_bit</span>(bitmap);<span style=color:#998;font-style:italic>//定位到true_size所在的index。举例说明：假设heap-&gt;free_bitmap＝0b100010, index=3,则bitmap＝(0b100),zend_mm_low_bit(bitmap)=3,最终index＝6
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>         best_fit <span style=color:#000;font-weight:700>=</span> heap<span style=color:#000;font-weight:700>-&gt;</span>free_buckets[index<span style=color:#000;font-weight:700>*</span><span style=color:#099>2</span>];<span style=color:#998;font-style:italic>//从free_buckets取出内存
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#999;font-weight:700;font-style:italic>#if ZEND_MM_CACHE_STAT
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         heap<span style=color:#000;font-weight:700>-&gt;</span>cache_stat[ZEND_MM_NUM_BUCKETS].hit<span style=color:#000;font-weight:700>++</span>;
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#endif
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         <span style=color:#000;font-weight:700>goto</span> zend_mm_finished_searching_for_block; <span style=color:#998;font-style:italic>//内存查找完成
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#if ZEND_MM_CACHE_STAT
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>   heap<span style=color:#000;font-weight:700>-&gt;</span>cache_stat[ZEND_MM_NUM_BUCKETS].miss<span style=color:#000;font-weight:700>++</span>;
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#endif
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>   <span style=color:#998;font-style:italic>//从大内存中查找，这部分逻辑，后续文章会写
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>   best_fit <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>zend_mm_search_large_block</span>(heap, true_size);
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>//如果大内存中也没有找到，且real_size已经超过php内存限制，则到剩余内存中查找
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>   <span style=color:#000;font-weight:700>if</span> (<span style=color:#000;font-weight:700>!</span>best_fit <span style=color:#000;font-weight:700>&amp;&amp;</span> heap<span style=color:#000;font-weight:700>-&gt;</span>real_size <span style=color:#000;font-weight:700>&gt;=</span> heap<span style=color:#000;font-weight:700>-&gt;</span>limit <span style=color:#000;font-weight:700>-</span> heap<span style=color:#000;font-weight:700>-&gt;</span>block_size) {
</span></span><span style=display:flex><span>      zend_mm_free_block <span style=color:#000;font-weight:700>*</span>p <span style=color:#000;font-weight:700>=</span> heap<span style=color:#000;font-weight:700>-&gt;</span>rest_buckets[<span style=color:#099>0</span>];
</span></span><span style=display:flex><span>      <span style=color:#458;font-weight:700>size_t</span> best_size <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>-</span><span style=color:#099>1</span>;
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>//取头节点并循环
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      <span style=color:#000;font-weight:700>while</span> (p <span style=color:#000;font-weight:700>!=</span> <span style=color:#900;font-weight:700>ZEND_MM_REST_BUCKET</span>(heap)) {
</span></span><span style=display:flex><span>         <span style=color:#000;font-weight:700>if</span> (<span style=color:#900;font-weight:700>UNEXPECTED</span>(<span style=color:#900;font-weight:700>ZEND_MM_FREE_BLOCK_SIZE</span>(p) <span style=color:#000;font-weight:700>==</span> true_size)) {
</span></span><span style=display:flex><span>            best_fit <span style=color:#000;font-weight:700>=</span> p;
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>goto</span> zend_mm_finished_searching_for_block;
</span></span><span style=display:flex><span>         } <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>if</span> (<span style=color:#900;font-weight:700>ZEND_MM_FREE_BLOCK_SIZE</span>(p) <span style=color:#000;font-weight:700>&gt;</span> true_size <span style=color:#000;font-weight:700>&amp;&amp;</span>
</span></span><span style=display:flex><span>                    <span style=color:#900;font-weight:700>ZEND_MM_FREE_BLOCK_SIZE</span>(p) <span style=color:#000;font-weight:700>&lt;</span> best_size) {
</span></span><span style=display:flex><span>            best_size <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>ZEND_MM_FREE_BLOCK_SIZE</span>(p);
</span></span><span style=display:flex><span>            best_fit <span style=color:#000;font-weight:700>=</span> p;
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         p <span style=color:#000;font-weight:700>=</span> p<span style=color:#000;font-weight:700>-&gt;</span>prev_free_block;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>//以上四个区域均未找到
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>   <span style=color:#000;font-weight:700>if</span> (<span style=color:#000;font-weight:700>!</span>best_fit) {
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>if</span> (true_size <span style=color:#000;font-weight:700>&gt;</span> heap<span style=color:#000;font-weight:700>-&gt;</span>block_size <span style=color:#000;font-weight:700>-</span> (ZEND_MM_ALIGNED_SEGMENT_SIZE <span style=color:#000;font-weight:700>+</span> ZEND_MM_ALIGNED_HEADER_SIZE)) {<span style=color:#998;font-style:italic>//true_size是否大于segment_size(block_size)，小于，则申请segment_size，大于则申请小于true_size的segment_size的整数位
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>         <span style=color:#998;font-style:italic>/* Make sure we add a memory block which is big enough,
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>            segment must have header &#34;size&#34; and trailer &#34;guard&#34; block */</span>
</span></span><span style=display:flex><span>         segment_size <span style=color:#000;font-weight:700>=</span> true_size <span style=color:#000;font-weight:700>+</span> ZEND_MM_ALIGNED_SEGMENT_SIZE <span style=color:#000;font-weight:700>+</span> ZEND_MM_ALIGNED_HEADER_SIZE;
</span></span><span style=display:flex><span>         segment_size <span style=color:#000;font-weight:700>=</span> (segment_size <span style=color:#000;font-weight:700>+</span> (heap<span style=color:#000;font-weight:700>-&gt;</span>block_size<span style=color:#000;font-weight:700>-</span><span style=color:#099>1</span>)) <span style=color:#000;font-weight:700>&amp;</span> <span style=color:#000;font-weight:700>~</span>(heap<span style=color:#000;font-weight:700>-&gt;</span>block_size<span style=color:#000;font-weight:700>-</span><span style=color:#099>1</span>);
</span></span><span style=display:flex><span>         keep_rest <span style=color:#000;font-weight:700>=</span> <span style=color:#099>1</span>;<span style=color:#998;font-style:italic>//如果keep_rest为1，则在后续处理剩余空闲内存时，将其放入剩余内存区域。这里的考虑应该是，当前剩余空闲内存会比较大。而且也会情况也会比较少，所以单独处理放入剩余内存区域(rest_buckets)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      } <span style=color:#000;font-weight:700>else</span> {
</span></span><span style=display:flex><span>         segment_size <span style=color:#000;font-weight:700>=</span> heap<span style=color:#000;font-weight:700>-&gt;</span>block_size;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>	  <span style=color:#998;font-style:italic>//校验内存是否超出限制
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      <span style=color:#000;font-weight:700>if</span> (segment_size <span style=color:#000;font-weight:700>&lt;</span> true_size <span style=color:#000;font-weight:700>||</span>
</span></span><span style=display:flex><span>          heap<span style=color:#000;font-weight:700>-&gt;</span>real_size <span style=color:#000;font-weight:700>+</span> segment_size <span style=color:#000;font-weight:700>&gt;</span> heap<span style=color:#000;font-weight:700>-&gt;</span>limit) {
</span></span><span style=display:flex><span>         <span style=color:#998;font-style:italic>/* Memory limit overflow */</span>
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#if ZEND_MM_CACHE
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         <span style=color:#900;font-weight:700>zend_mm_free_cache</span>(heap);
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#endif
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         <span style=color:#900;font-weight:700>HANDLE_UNBLOCK_INTERRUPTIONS</span>();
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#if ZEND_DEBUG
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         <span style=color:#900;font-weight:700>zend_mm_safe_error</span>(heap, <span style=color:#d14>&#34;Allowed memory size of %ld bytes exhausted at %s:%d (tried to allocate %lu bytes)&#34;</span>, heap<span style=color:#000;font-weight:700>-&gt;</span>limit, __zend_filename, __zend_lineno, size);
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#else
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         <span style=color:#900;font-weight:700>zend_mm_safe_error</span>(heap, <span style=color:#d14>&#34;Allowed memory size of %ld bytes exhausted (tried to allocate %lu bytes)&#34;</span>, heap<span style=color:#000;font-weight:700>-&gt;</span>limit, size);
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#endif
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>      }
</span></span><span style=display:flex><span>	 <span style=color:#998;font-style:italic>//向系统申请内存
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      segment <span style=color:#000;font-weight:700>=</span> (zend_mm_segment <span style=color:#000;font-weight:700>*</span>) <span style=color:#900;font-weight:700>ZEND_MM_STORAGE_ALLOC</span>(segment_size);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>if</span> (<span style=color:#000;font-weight:700>!</span>segment) {
</span></span><span style=display:flex><span>         <span style=color:#998;font-style:italic>/* Storage manager cannot allocate memory */</span>
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#if ZEND_MM_CACHE
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         <span style=color:#900;font-weight:700>zend_mm_free_cache</span>(heap);
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#endif
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span><span style=color:#900;font-weight:700>out_of_memory</span>:
</span></span><span style=display:flex><span>         <span style=color:#900;font-weight:700>HANDLE_UNBLOCK_INTERRUPTIONS</span>();
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#if ZEND_DEBUG
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         <span style=color:#900;font-weight:700>zend_mm_safe_error</span>(heap, <span style=color:#d14>&#34;Out of memory (allocated %ld) at %s:%d (tried to allocate %lu bytes)&#34;</span>, heap<span style=color:#000;font-weight:700>-&gt;</span>real_size, __zend_filename, __zend_lineno, size);
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#else
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         <span style=color:#900;font-weight:700>zend_mm_safe_error</span>(heap, <span style=color:#d14>&#34;Out of memory (allocated %ld) (tried to allocate %lu bytes)&#34;</span>, heap<span style=color:#000;font-weight:700>-&gt;</span>real_size, size);
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#endif
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>         <span style=color:#000;font-weight:700>return</span> <span style=color:#0086b3>NULL</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#998;font-style:italic>//更新heap统计字段
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      heap<span style=color:#000;font-weight:700>-&gt;</span>real_size <span style=color:#000;font-weight:700>+=</span> segment_size;
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>if</span> (heap<span style=color:#000;font-weight:700>-&gt;</span>real_size <span style=color:#000;font-weight:700>&gt;</span> heap<span style=color:#000;font-weight:700>-&gt;</span>real_peak) {
</span></span><span style=display:flex><span>         heap<span style=color:#000;font-weight:700>-&gt;</span>real_peak <span style=color:#000;font-weight:700>=</span> heap<span style=color:#000;font-weight:700>-&gt;</span>real_size;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      segment<span style=color:#000;font-weight:700>-&gt;</span>size <span style=color:#000;font-weight:700>=</span> segment_size;
</span></span><span style=display:flex><span>      segment<span style=color:#000;font-weight:700>-&gt;</span>next_segment <span style=color:#000;font-weight:700>=</span> heap<span style=color:#000;font-weight:700>-&gt;</span>segments_list;
</span></span><span style=display:flex><span>      heap<span style=color:#000;font-weight:700>-&gt;</span>segments_list <span style=color:#000;font-weight:700>=</span> segment;
</span></span><span style=display:flex><span>      <span style=color:#998;font-style:italic>//格式化申请的内存 为zend_mm_free_block
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      best_fit <span style=color:#000;font-weight:700>=</span> (zend_mm_free_block <span style=color:#000;font-weight:700>*</span>) ((<span style=color:#458;font-weight:700>char</span> <span style=color:#000;font-weight:700>*</span>) segment <span style=color:#000;font-weight:700>+</span> ZEND_MM_ALIGNED_SEGMENT_SIZE);
</span></span><span style=display:flex><span>      <span style=color:#900;font-weight:700>ZEND_MM_MARK_FIRST_BLOCK</span>(best_fit);<span style=color:#998;font-style:italic>//初始化block中prev字段
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	  <span style=color:#998;font-style:italic>//这里最后的ZEND_MM_ALIGNED_HEADER_SIZE是预留在最后的remaining_size使用的
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      block_size <span style=color:#000;font-weight:700>=</span> segment_size <span style=color:#000;font-weight:700>-</span> ZEND_MM_ALIGNED_SEGMENT_SIZE <span style=color:#000;font-weight:700>-</span> ZEND_MM_ALIGNED_HEADER_SIZE;
</span></span><span style=display:flex><span>	  <span style=color:#998;font-style:italic>//初始化新segment的能存末位的 zend_mm_block
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      <span style=color:#900;font-weight:700>ZEND_MM_LAST_BLOCK</span>(<span style=color:#900;font-weight:700>ZEND_MM_BLOCK_AT</span>(best_fit, block_size));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   } <span style=color:#000;font-weight:700>else</span> {
</span></span><span style=display:flex><span><span style=color:#900;font-weight:700>zend_mm_finished_searching_for_block</span>:
</span></span><span style=display:flex><span>      <span style=color:#998;font-style:italic>/* remove from free list */</span>
</span></span><span style=display:flex><span>      <span style=color:#900;font-weight:700>ZEND_MM_CHECK_MAGIC</span>(best_fit, MEM_BLOCK_FREED);
</span></span><span style=display:flex><span>      <span style=color:#900;font-weight:700>ZEND_MM_CHECK_COOKIE</span>(best_fit);
</span></span><span style=display:flex><span>      <span style=color:#900;font-weight:700>ZEND_MM_CHECK_BLOCK_LINKAGE</span>(best_fit);
</span></span><span style=display:flex><span>      <span style=color:#900;font-weight:700>zend_mm_remove_from_free_list</span>(heap, best_fit);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      block_size <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>ZEND_MM_FREE_BLOCK_SIZE</span>(best_fit);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>//计算使用后的剩余内存
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>   remaining_size <span style=color:#000;font-weight:700>=</span> block_size <span style=color:#000;font-weight:700>-</span> true_size;
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>//如果剩余内存小于block的头部大小，则将其合并到true_size中
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>   <span style=color:#000;font-weight:700>if</span> (remaining_size <span style=color:#000;font-weight:700>&lt;</span> ZEND_MM_ALIGNED_MIN_HEADER_SIZE) {
</span></span><span style=display:flex><span>      true_size <span style=color:#000;font-weight:700>=</span> block_size;
</span></span><span style=display:flex><span>      <span style=color:#900;font-weight:700>ZEND_MM_BLOCK</span>(best_fit, ZEND_MM_USED_BLOCK, true_size);
</span></span><span style=display:flex><span>   } <span style=color:#000;font-weight:700>else</span> {<span style=color:#998;font-style:italic>//否则，将剩余内存放入到heap中
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      zend_mm_free_block <span style=color:#000;font-weight:700>*</span>new_free_block;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#998;font-style:italic>/* prepare new free block */</span> 
</span></span><span style=display:flex><span>      <span style=color:#900;font-weight:700>ZEND_MM_BLOCK</span>(best_fit, ZEND_MM_USED_BLOCK, true_size);
</span></span><span style=display:flex><span>      new_free_block <span style=color:#000;font-weight:700>=</span> (zend_mm_free_block <span style=color:#000;font-weight:700>*</span>) <span style=color:#900;font-weight:700>ZEND_MM_BLOCK_AT</span>(best_fit, true_size);<span style=color:#998;font-style:italic>//定位并格式化剩下的空闲内存
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      <span style=color:#900;font-weight:700>ZEND_MM_BLOCK</span>(new_free_block, ZEND_MM_FREE_BLOCK, remaining_size);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#998;font-style:italic>/* add the new free block to the free list */</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>if</span> (<span style=color:#900;font-weight:700>EXPECTED</span>(<span style=color:#000;font-weight:700>!</span>keep_rest)) {<span style=color:#998;font-style:italic>//这里请看上面代码中对keep_rest赋值时的解释
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>         <span style=color:#900;font-weight:700>zend_mm_add_to_free_list</span>(heap, new_free_block);
</span></span><span style=display:flex><span>      } <span style=color:#000;font-weight:700>else</span> {
</span></span><span style=display:flex><span>         <span style=color:#900;font-weight:700>zend_mm_add_to_rest_list</span>(heap, new_free_block);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#900;font-weight:700>ZEND_MM_SET_DEBUG_INFO</span>(best_fit, size, <span style=color:#099>1</span>, <span style=color:#099>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   heap<span style=color:#000;font-weight:700>-&gt;</span>size <span style=color:#000;font-weight:700>+=</span> true_size;
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>if</span> (heap<span style=color:#000;font-weight:700>-&gt;</span>peak <span style=color:#000;font-weight:700>&lt;</span> heap<span style=color:#000;font-weight:700>-&gt;</span>size) {
</span></span><span style=display:flex><span>      heap<span style=color:#000;font-weight:700>-&gt;</span>peak <span style=color:#000;font-weight:700>=</span> heap<span style=color:#000;font-weight:700>-&gt;</span>size;
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#900;font-weight:700>HANDLE_UNBLOCK_INTERRUPTIONS</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>ZEND_MM_DATA_OF</span>(best_fit);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>以上就是emalloc的所有逻辑了。</p><h4 id=四个内存区域的区分>四个内存区域的区分</h4><p>基于64位系统</p><ul><li><p>缓存区 cache</p><p>todo</p></li><li><p>小内存区 free_buckets</p><p>当申请的内存小于<strong>520b</strong>时候，放入小内存区。这个数字是怎么来的呢。</p><p>逆推：当申请520b内存是，其true_size内存为520b+16(ZEND_MM_ALIGNED_HEADER_SIZE)=536，那么其实是需要536b大小的内存的。这其中还包含占用32b的<code>zend_mm_small_free_block</code>结构体<code>zend_mm_small_free_block</code>大小是固定的，所以不计入index计算，所以小内存区最大存入504b的内存，将504b按照计算index的方式逆推即右移3为则为最大的index值63。</p><p>正推：又因为小内存数组的长度为64*2。这里要看成64组，所以小内存数组的index的最大值63＊2。</p><p>综上，因为小内存数组最大index为63（64位系统），所以其所能存储的最大值</p></li><li><p>大内存区 large_free_buckets</p><p>不满足<strong>小内存区</strong>条件和<strong>剩余内存</strong>条件的放入large_free_buckets</p></li><li><p>剩余内存区</p><p>当heap中没有合适大小的内存向内核申请时，如果申请的大小大于heap->block_size。则当有额外剩下的内存时，放入到<strong>剩余内存区rest_bucket</strong>。举个例子假设heap->block_size＝256k。如果emalloc申请的大小小于256k，则剩下的内存存入<strong>大内存区large_free_bucket</strong>，否则 emalloc 申请的大小大于256k时，则剩下的内存存入<strong>剩余内存区rest_buckets</strong>中</p></li></ul><ul class=pa0>标签：<li class="list di"><a href=/tags/php class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">php</a></li><li class="list di"><a href=/tags/c class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">c</a></li></ul><ul class=pa0>分类：<li class="list di"><a href=/categories/php class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">php</a></li></ul><div class="mt6 instapaper_ignoref"><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//petrie.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">相关內容</p><ul class="pa0 list"><li class=mb2><a href=/2018/04/php%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86zmm%E4%BA%8C%E5%B8%B8%E8%A7%81%E5%AE%8F%E7%9A%84%E5%80%BC/>PHP内存管理ZMM（二）－常见宏的值</a></li><li class=mb2><a href=/2018/03/php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%89%A9%E5%B1%95%E9%AA%A8%E6%9E%B6/>PHP扩展开发－自动生成扩展骨架</a></li><li class=mb2><a href=/2018/03/%E5%A6%82%E4%BD%95%E7%8B%AC%E7%AB%8B%E7%9A%84%E4%BD%BF%E7%94%A8laravel%E7%9A%84ioc%E5%8A%9F%E8%83%BD/>如何独立的使用Laravel的IOC功能</a></li><li class=mb2><a href=/2017/06/php%E8%AE%BE%E7%BD%AE%E8%BF%9E%E6%8E%A5mysql%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4/>PHP设置连接mysql超时时间</a></li><li class=mb2><a href=/2017/04/%E6%9B%B4%E6%96%B0mac%E7%9A%84php%E9%BB%98%E8%AE%A4%E7%89%88%E6%9C%AC/>更新Mac的PHP默认版本</a></li><li class=mb2><a href=/2016/06/nignx-php%E4%B8%ADhttp%E8%AF%B7%E6%B1%82%E8%BF%94%E5%9B%9E502/>Nignx+PHP中HTTP请求返回502</a></li><li class=mb2><a href=/2015/03/ci-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/>CI 环境配置</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://petrie.github.io/>&copy; Petrie's Site 2023</a><div><div class=ananke-socials><a href=https://github.com/petrie target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>